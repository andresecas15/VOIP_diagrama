<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo Taller - Odoo Timesheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .odoo-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        .mermaid { 
            background-color: white; 
            border-radius: 8px; 
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <span class="text-[#714B67]">Odoo</span> Integraci√≥n Voz (Fase 1)
            </h1>
            <p class="text-gray-600">Registro de Horas Hombre mediante Comandos de Voz (Fonax)</p>
        </div>

        <div class="odoo-card bg-white rounded-xl p-6 mb-8 overflow-x-auto">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">L√≥gica de Procesamiento de Logs</h2>
            
            <div class="mermaid">
flowchart TD
    %% Entradas de Datos
    FonaxPush["üì° Webhook Fonax<br/>Push Inmediato"] --> LogTable
    FonaxPoll["‚è∞ Cron Odoo<br/>Poll de Auditor√≠a (Backup)"] --> LogTable
    
    %% Almacenamiento Intermedio (Auditor√≠a)
    subgraph AuditLayer [Capa de Auditor√≠a y Seguridad]
        LogTable["üóÉÔ∏è Modelo: fonax.call.log<br/>Guarda: Ext, Emp, Orden, Texto, Hora"]
    end

    LogTable --> Process{"‚öôÔ∏è Procesar Log<br/>(Estado: Nuevo)"}
    
    %% Identificaci√≥n de Recursos
    Process --> FindEmp{"üîç ¬øEmpleado Existe?<br/>(Match por Voz/Extensi√≥n)"}
    FindEmp -- No --> ErrorEmp["‚ö†Ô∏è Marcar Log: Error<br/>'Empleado Desconocido'"]
    
    FindEmp -- S√≠ --> FindSO{"üîç ¬øOrden S005 Existe?<br/>(Buscar sale.order)"}
    FindSO -- No --> ErrorSO["‚ö†Ô∏è Marcar Log: Error<br/>'Orden no encontrada'"]
    
    %% L√≥gica de Negocio (Timer)
    FindSO -- S√≠ --> IdentifyAction{"üß† An√°lisis Sem√°ntico<br/>¬øInicio o Fin?"}
    
    %% Camino: INICIO DE TRABAJO
    IdentifyAction -- "Voy a trabajar..." --> CheckOpen["¬øTiene Timer Abierto?"]
    CheckOpen -- S√≠ --> ClosePrev["‚èπÔ∏è Cierra Timer Anterior<br/>(Seguridad)"] --> CreateNew
    CheckOpen -- No --> CreateNew
    
    CreateNew["‚ñ∂Ô∏è <b>Crear Timesheet</b><br/>User: Pedro<br/>Project: S005<br/>Start: Now"] --> MarkDone["‚úÖ Log: Procesado"]
    
    %% Camino: FIN DE TRABAJO / REPORTE
    IdentifyAction -- "Termin√©..." --> FindOpenTimer["üîç Buscar Timesheet<br/>Abierto de Pedro en S005"]
    
    FindOpenTimer -- Encontrado --> CloseTimer["‚èπÔ∏è <b>Cerrar Timesheet</b><br/>Calc Duraci√≥n: Now - Start<br/>Desc: 'Cambio de Caucho'"]
    FindOpenTimer -- No Encontrado --> LogLoose["üìù Registrar Entrada Suelta<br/>(Sin duraci√≥n calculada)"]
    
    CloseTimer --> MarkDone
    LogLoose --> MarkDone

    %% Estilos Visuales
    classDef purple fill:#714B67,color:white,stroke:#714B67,stroke-width:2px;
    classDef teal fill:#00A09D,color:white,stroke:#00A09D,stroke-width:2px;
    classDef red fill:#fee2e2,stroke:#ef4444,color:#991b1b,stroke-width:2px;
    classDef gray fill:#f3f4f6,stroke:#9ca3af,color:#1f2937,stroke-width:2px;

    class FonaxPush,FonaxPoll,LogTable purple
    class CreateNew,CloseTimer,ClosePrev,LogLoose teal
    class ErrorEmp,ErrorSO red
    class Process,FindEmp,FindSO,IdentifyAction,CheckOpen,FindOpenTimer,MarkDone gray
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="odoo-card bg-white rounded-xl p-6">
                <h3 class="font-bold text-[#714B67] mb-3">üõ†Ô∏è Modelo de Auditor√≠a (fonax.call.log)</h3>
                <p class="text-sm text-gray-600 mb-2">Este modelo es vital para cumplir con el requisito de "no dejar transacciones perdidas".</p>
                <ul class="space-y-2 text-sm text-gray-600 list-disc list-inside">
                    <li><b>Campos:</b> Raw JSON, Estado (Nuevo/Hecho/Error), Mensaje de Error.</li>
                    <li><b>Funci√≥n:</b> Permite al gerente corregir manualmente si Pedro dijo "S0005" y el sistema no lo entendi√≥, re-procesando el log con un clic.</li>
                </ul>
            </div>
            <div class="odoo-card bg-white rounded-xl p-6">
                <h3 class="font-bold text-[#00A09D] mb-3">‚è±Ô∏è C√°lculo de Horas (account.analytic.line)</h3>
                <p class="text-sm text-gray-600 mb-2">L√≥gica de estado para calcular la duraci√≥n exacta:</p>
                <ul class="space-y-2 text-sm text-gray-600 list-disc list-inside">
                    <li><b>Inicio:</b> Crea registro con <code>date_start = Now</code> y <code>unit_amount = 0</code>.</li>
                    <li><b>Fin:</b> Busca el √∫ltimo registro en 0, calcula <code>Now - date_start</code> y actualiza el campo <code>unit_amount</code>.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Script de Mermaid -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'base',
            flowchart: { curve: 'basis' },
            themeVariables: {
                primaryColor: '#714B67',
                primaryTextColor: '#fff',
                primaryBorderColor: '#714B67',
                lineColor: '#6b7280',
                secondaryColor: '#00A09D',
                tertiaryColor: '#fff'
            }
        });

        await mermaid.run({ querySelector: '.mermaid' });
    </script>
</body>
</html>