<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flujo de IntegraciÃ³n VoIP - Odoo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .odoo-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        /* Estilo base para el contenedor del diagrama */
        .mermaid { 
            background-color: white; 
            border-radius: 8px; 
            display: flex;
            justify-content: center;
            padding: 20px;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <span class="text-[#714B67]">Odoo 18</span> VoIP Integration Flow
            </h1>
            <p class="text-gray-600">LÃ³gica de DecisiÃ³n para Procesamiento de Webhooks</p>
        </div>

        <div class="odoo-card bg-white rounded-xl p-6 mb-8 overflow-x-auto">
            <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Diagrama de Flujo LÃ³gico</h2>
            
            <!-- Usamos DIV en lugar de PRE y aseguramos que el contenido no tenga espacios extraÃ±os -->
            <div class="mermaid">
flowchart TD
    %% Nodos de Inicio
    Start((Inicio)) --> Webhook["ğŸ“¡ Recibir Webhook POST<br/>/webhook/voip_callback"]
    
    %% ValidaciÃ³n de Seguridad
    Webhook --> Auth{"ğŸ” Â¿Token VÃ¡lido?"}
    Auth -- No --> Deny["â›” Retornar 403 Forbidden"] --> EndErr((Fin Error))
    Auth -- SÃ­ --> Ack["âœ… Retornar 200 OK<br/>(Liberar ConexiÃ³n)"]
    
    %% Proceso AsÃ­ncrono
    Ack --> Queue["âš™ï¸ Crear Queue Job / Cron"]
    Queue --> Wait["â³ Espera TÃ©cnica 30s<br/>Buffer de Procesamiento"]
    
    %% Consulta a API Externa
    Wait --> Fetch["ğŸ“¥ GET /api/transcripts<br/>Consultar a Proveedor Voip"]
    Fetch --> CheckData{"Â¿Datos Recibidos?"}
    
    CheckData -- Error/VacÃ­o --> Retry["ğŸ”„ Reagendar Job<br/>(Reintento AutomÃ¡tico)"] --> EndRetry((Fin Reintento))
    CheckData -- OK --> Search["ğŸ” Buscar en res.partner<br/>por nÃºmero de telÃ©fono"]
    
    %% LÃ³gica de Negocio Odoo
    Search --> Found{"Â¿Partner Existe?"}
    
    Found -- SÃ­ --> SetPartner["ğŸ‘¤ Seleccionar Partner"]
    Found -- No --> CreateLead["âœ¨ Crear CRM Lead<br/>(Nuevo Prospecto)"]
    
    %% PublicaciÃ³n Final
    SetPartner --> Format["ğŸ“ Formatear HTML<br/>(Negritas, Detalles)"]
    CreateLead --> Format
    
    Format --> Post["ğŸ’¬ message_post<br/>Publicar en Chatter"]
    Post --> End((Fin Ã‰xito))

    %% Estilos Odoo
    classDef purple fill:#714B67,color:white,stroke:#714B67,stroke-width:2px;
    classDef teal fill:#00A09D,color:white,stroke:#00A09D,stroke-width:2px;
    classDef gray fill:#f3f4f6,stroke:#9ca3af,color:#1f2937,stroke-width:2px,stroke-dasharray: 5 5;
    classDef warning fill:#fff7ed,stroke:#f97316,color:#9a3412,stroke-width:2px;

    class Webhook,Queue,Fetch,Search purple
    class Post,SetPartner,CreateLead,Format teal
    class Start,EndErr,EndRetry,End,Ack gray
    class Auth,Found,CheckData warning
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="odoo-card bg-white rounded-xl p-6">
                <h3 class="font-bold text-[#714B67] mb-3">ğŸŸ£ Capa de Infraestructura</h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex items-start"><span class="mr-2">ğŸ“¡</span><div><strong>Webhook & Auth:</strong> Filtra peticiones maliciosas antes de procesar nada.</div></li>
                    <li class="flex items-start"><span class="mr-2">â³</span><div><strong>Buffer de Espera:</strong> Crucial para dar tiempo a la IA de VoIP a generar el texto.</div></li>
                    <li class="flex items-start"><span class="mr-2">ğŸ”„</span><div><strong>Reintentos:</strong> Si la API falla, el sistema se autorrepara reagendando el trabajo.</div></li>
                </ul>
            </div>
            <div class="odoo-card bg-white rounded-xl p-6">
                <h3 class="font-bold text-[#00A09D] mb-3">ğŸŸ¢ Capa de Negocio</h3>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex items-start"><span class="mr-2">ğŸ‘¤</span><div><strong>DetecciÃ³n Inteligente:</strong> Asocia la llamada al cliente existente automÃ¡ticamente.</div></li>
                    <li class="flex items-start"><span class="mr-2">âœ¨</span><div><strong>GeneraciÃ³n de Leads:</strong> Convierte llamadas desconocidas en oportunidades de venta.</div></li>
                    <li class="flex items-start"><span class="mr-2">ğŸ“</span><div><strong>Formato Rico:</strong> Usa HTML para que la transcripciÃ³n sea legible y limpia.</div></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Script Corregido con extensiÃ³n .mjs -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        
        mermaid.initialize({ 
            startOnLoad: false, // Controlamos la carga manualmente
            theme: 'base',
            flowchart: { curve: 'monotoneY' },
            themeVariables: {
                primaryColor: '#714B67',
                primaryTextColor: '#fff',
                primaryBorderColor: '#714B67',
                lineColor: '#6b7280',
                secondaryColor: '#00A09D',
                tertiaryColor: '#fff'
            }
        });

        // Forzamos el renderizado asÃ­ncrono
        await mermaid.run({
            querySelector: '.mermaid',
        });
    </script>
</body>
</html>